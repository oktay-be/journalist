name: Publish Python üêç distribution üì¶ to PyPI and TestPyPI

on:
  # Triggers disabled - workflow can only be run manually
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (optional)"
        required: false
        default: ""
  # push:
  #   tags:
  #     - "v*" # Trigger on tags like v1.0.0
  # release:
  #   types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install
      - name: Run tests
        run: poetry run pytest

  publish-test:
    needs: test
    if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-') # Only for pre-release tags like v1.0.0-beta
    runs-on: ubuntu-latest
    environment: test-pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - run: python -m pip install build
      - run: python -m build
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  publish:
    needs: test
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-') # Only for release tags like v1.0.0
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - run: python -m pip install build
      - run: python -m build
      - uses: pypa/gh-action-pypi-publish@release/v1
